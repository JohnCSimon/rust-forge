<!DOCTYPE html>
<!-- Page last generated 2019-09-06 21:23:38 +0000 -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Handling of tools embedded in the rustc repo ("toolstate")</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Rust, Rust programming language, rustlang, rust-lang, Mozilla Rust">
    <meta name="description" content="A systems programming language that runs blazingly fast, prevents segfaults, and guarantees thread safety.">
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/forge.css">
    <link rel="stylesheet" href="/rust-forge/css/bootstrap.css">
    <link rel="stylesheet" href="/rust-forge/css/style.css">
    <link rel="stylesheet" href="/rust-forge/css/forge.css">
  </head>

  <body class="container">

    <header>

    <ul class="row menu">
      <li class="col-xs-12 col-md-2">
        <a href="index.html">
	  <!-- FIXME: absolute urls -->
          <img class="img-responsive" src="https://www.rust-lang.org/logos/rust-logo-blk.svg" onerror="this.src='https://www.rust-lang.org/logos/rust-logo-256x256-blk.png'" height="128" width="128" alt="Rust logo" />
        </a>
      </li>
      <li class="col-xs-12 col-md-6 menu">
	<h1>Rust Forge</h1>
      </li>
    </ul>
    </header>

    <div class="content"><h1 id="handling-of-tools-embedded-in-the-rustc-repo-toolstate">Handling of tools embedded in the rustc repo (“toolstate”)</h1>

<p>The Rust repository contains several external tools and documents as git
submodules (e.g. clippy, rls, the <a href="https://doc.rust-lang.org/book/">Book</a>, the <a href="https://doc.rust-lang.org/reference/">Reference</a>). Many of those are
very tightly coupled to the compiler and depend on internal APIs that change all
the time, but they are not actually essential to get the compiler itself to
work. To make API changes less painful, these tools are allowed to “break”
temporarily. PRs can still land and nightlies still get released even when some
tools are broken. Their current status is managed by the
<a href="https://rust-lang-nursery.github.io/rust-toolstate/">toolstate system</a>. (Cargo is not subject to the toolstate system and
instead just has to always work.)</p>

<p>The three possible states of a “tool” (this includes the documentation managed
by the toolstate system, where we run doctests) are: <code class="highlighter-rouge">test-pass</code>, <code class="highlighter-rouge">test-fail</code>,
<code class="highlighter-rouge">build-fail</code>.</p>

<p>This page gives a rough overview how the toolstate system works, and what the
rules are for when which tools are (not) allowed to break.</p>

<h2 id="toolstate-rules">Toolstate Rules</h2>

<ul>
  <li>
    <p>For all tools, if a PR changes that tool (if it changes the commit used by the
submodule), the tool has to be in <code class="highlighter-rouge">test-pass</code> after this PR or else CI will
fail.</p>
  </li>
  <li>
    <p>For all tools except for “nightly only” tools, the following extra rules are applied:</p>
    <ul>
      <li>If a PR lands on the <code class="highlighter-rouge">beta</code> or <code class="highlighter-rouge">stable</code> branch, the tool has to be <code class="highlighter-rouge">test-pass</code>.</li>
      <li>If a PR lands on <code class="highlighter-rouge">master</code> in the week before the beta is cut, and that PR
regresses the tool (if it makes the state “worse”), CI fails. This is to
help make sure all these tools become <code class="highlighter-rouge">test-pass</code> so that a beta can be
cut. (See the <a href="index.html">Forge index</a> for when the next beta cutoff is
happening.)</li>
    </ul>

    <p>At the time of writing, the following tools are “nightly only”: rustc-guide,
  miri, embedded-book.</p>
  </li>
</ul>

<h2 id="updating-the-toolstate-repository">Updating the toolstate repository</h2>

<p>Updating the <a href="https://github.com/rust-lang-nursery/rust-toolstate/">toolstate repository</a> happens in two steps: when CI
runs on the <code class="highlighter-rouge">auto</code> branch (where bors moves a PR to test if it is good for
integration), the “tool” runners for the individual platforms (at the time of
writing, Linux and Windows) each submit a JSON file to the repository recording
the state of each tool for the commit they are testing. Later, if that commit
actually entirely passed CI and bors moves it to the <code class="highlighter-rouge">master</code> branch, the
“current tool status” in the toolstate repository is updated appropriately.</p>

<p>These scripts also automatically ping some people and create issues when tools
break.</p>

<p>For further details, see the comments in the involved files: <a href="https://github.com/rust-lang/rust/blob/master/src/ci/docker/x86_64-gnu-tools/checktools.sh"><code class="highlighter-rouge">checktools.sh</code></a>,
<a href="https://github.com/rust-lang/rust/blob/master/src/tools/publish_toolstate.py"><code class="highlighter-rouge">publish_toolstate.py</code></a> as well as the other files mentioned there.</p>

<h2 id="adding-a-tool">Adding a tool</h2>

<p>To add a new tool to be tracked, the following steps must be taken:</p>

<ol>
  <li>Create a PR to rust-lang/rust that adds the submodule along with any
necessary build system / bootstrap updates. Be careful that the tests
properly support <code class="highlighter-rouge">./x.py --no-fail-fast</code> to avoid
<a href="https://github.com/rust-lang/rust/pull/63089">issues like this</a>.</li>
  <li>Include changes to <a href="https://github.com/rust-lang/rust/blob/master/src/ci/docker/x86_64-gnu-tools/checktools.sh"><code class="highlighter-rouge">checktools.sh</code></a>:
    <ul>
      <li>Build the tool at the top. This is the step that actually generates the
JSON status for the tool. When <code class="highlighter-rouge">save-toolstates</code> is set in
<code class="highlighter-rouge">config.toml</code>, the rust build system will write a JSON file with the
status of each test.</li>
      <li>Add the tool to <code class="highlighter-rouge">status_check</code> with whether it should be a beta blocker
or not.</li>
    </ul>
  </li>
  <li>Update <a href="https://github.com/rust-lang/rust/blob/master/src/tools/publish_toolstate.py"><code class="highlighter-rouge">publish_toolstate.py</code></a> to add the tool. This includes a list of
people to ping if the tool is broken, and its source repo. (Note: At the
time of this writing, these users must have permissions to be assignable on
rust-lang/rust GitHub.)</li>
  <li>Submit a PR to the <a href="https://github.com/rust-lang-nursery/rust-toolstate/">toolstate repository</a> to manually add the tool to the
<a href="https://github.com/rust-lang-nursery/rust-toolstate/blob/master/_data/latest.json"><code class="highlighter-rouge">latest.json</code></a> file.</li>
</ol>

</div>

  </body>
</html>
